{% extends "base_premium.html" %}

{% block title %}Security Dashboard{% endblock %}
{% block page_title %}Security Dashboard{% endblock %}

{% block extra_css %}
<style>
    .dashboard-hero {
        background: var(--glass-light);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-2xl);
        padding: var(--space-12) var(--space-8);
        margin-bottom: var(--space-8);
        position: relative;
        overflow: hidden;
        text-align: center;
    }

    .dashboard-hero::before {
        content: '';
        position: absolute;
        top: -50%;
        left: -50%;
        width: 200%;
        height: 200%;
        background: radial-gradient(circle, rgba(102, 126, 234, 0.1) 0%, transparent 70%);
        animation: heroRotate 20s linear infinite;
    }

    @keyframes heroRotate {
        from { transform: rotate(0deg); }
        to { transform: rotate(360deg); }
    }

    .hero-content {
        position: relative;
        z-index: 1;
    }

    .hero-icon {
        font-size: 80px;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--space-4);
        animation: float 3s ease-in-out infinite;
    }

    .hero-title {
        font-family: var(--font-display);
        font-size: 48px;
        font-weight: 900;
        background: var(--primary-gradient);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: var(--space-3);
        letter-spacing: -1px;
    }

    .hero-subtitle {
        font-size: 20px;
        color: var(--text-secondary);
        margin-bottom: var(--space-6);
    }

    .live-indicator {
        display: inline-flex;
        align-items: center;
        gap: var(--space-2);
        padding: var(--space-2) var(--space-4);
        background: rgba(74, 222, 128, 0.2);
        border-radius: var(--radius-full);
        font-size: 14px;
        font-weight: 600;
        color: #4ade80;
    }

    .metric-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
        gap: var(--space-6);
        margin-bottom: var(--space-8);
    }

    .metric-card {
        background: var(--glass-light);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
        position: relative;
        overflow: hidden;
        transition: all 0.3s ease;
    }

    .metric-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 4px;
        transform: scaleX(0);
        transform-origin: left;
        transition: transform 0.3s ease;
    }

    .metric-card.primary::before {
        background: var(--primary-gradient);
    }

    .metric-card.success::before {
        background: var(--success-gradient);
    }

    .metric-card.warning::before {
        background: var(--warning-gradient);
    }

    .metric-card.danger::before {
        background: var(--danger-gradient);
    }

    .metric-card:hover {
        transform: translateY(-8px);
        box-shadow: var(--shadow-2xl);
    }

    .metric-card:hover::before {
        transform: scaleX(1);
    }

    .metric-header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        margin-bottom: var(--space-4);
    }

    .metric-icon {
        width: 56px;
        height: 56px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 28px;
        position: relative;
    }

    .metric-icon::after {
        content: '';
        position: absolute;
        inset: -4px;
        border-radius: var(--radius-md);
        opacity: 0.3;
        animation: iconPulse 2s ease-in-out infinite;
    }

    .metric-icon.primary {
        background: var(--primary-gradient);
    }

    .metric-icon.primary::after {
        background: var(--primary-gradient);
    }

    .metric-icon.success {
        background: var(--success-gradient);
    }

    .metric-icon.success::after {
        background: var(--success-gradient);
    }

    .metric-icon.warning {
        background: var(--warning-gradient);
    }

    .metric-icon.warning::after {
        background: var(--warning-gradient);
    }

    .metric-icon.danger {
        background: var(--danger-gradient);
    }

    .metric-icon.danger::after {
        background: var(--danger-gradient);
    }

    .metric-value {
        font-family: var(--font-display);
        font-size: 36px;
        font-weight: 700;
        color: var(--text-primary);
        line-height: 1;
        margin-bottom: var(--space-2);
    }

    .metric-label {
        font-size: 13px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 1px;
        font-weight: 600;
    }

    .metric-trend {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        margin-top: var(--space-3);
        font-size: 13px;
        font-weight: 600;
    }

    .analytics-section {
        display: grid;
        grid-template-columns: 2fr 1fr;
        gap: var(--space-6);
        margin-bottom: var(--space-8);
    }

    .chart-card {
        background: var(--glass-light);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
    }

    .chart-container {
        height: 300px;
        background: var(--glass-dark);
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        margin-top: var(--space-4);
        color: var(--text-muted);
    }

    .control-panel {
        background: var(--glass-light);
        backdrop-filter: blur(20px);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-xl);
        padding: var(--space-6);
    }

    .control-grid {
        display: grid;
        gap: var(--space-3);
        margin-top: var(--space-4);
    }

    .control-button {
        background: var(--glass-dark);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: var(--space-4);
        display: flex;
        align-items: center;
        gap: var(--space-3);
        cursor: pointer;
        transition: all 0.2s ease;
        text-decoration: none;
        color: var(--text-primary);
    }

    .control-button:hover {
        background: var(--glass-medium);
        transform: translateX(4px);
        color: var(--text-primary);
    }

    .control-icon {
        width: 40px;
        height: 40px;
        border-radius: var(--radius-md);
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 18px;
    }

    .control-icon.primary {
        background: var(--primary-gradient);
    }

    .control-icon.success {
        background: var(--success-gradient);
    }

    .control-icon.warning {
        background: var(--warning-gradient);
    }

    .control-icon.danger {
        background: var(--danger-gradient);
    }

    .control-text {
        flex: 1;
    }

    .control-title {
        font-size: 14px;
        font-weight: 600;
        margin-bottom: 2px;
    }

    .control-desc {
        font-size: 12px;
        color: var(--text-muted);
    }

    @media (max-width: 1024px) {
        .analytics-section {
            grid-template-columns: 1fr;
        }
        
        .hero-title {
            font-size: 36px;
        }
    }

    @media (max-width: 768px) {
        .metric-grid {
            grid-template-columns: 1fr;
        }
        
        .hero-title {
            font-size: 28px;
        }
        
        .hero-subtitle {
            font-size: 16px;
        }
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="dashboard-hero">
    <div class="hero-content">
        <div class="hero-icon">
            <i class="fas fa-shield-alt"></i>
        </div>
        <h1 class="hero-title">SECURITY COMMAND CENTER</h1>
        <p class="hero-subtitle">Real-time Monitoring & System Control</p>
        <div class="live-indicator">
            <span class="pulse-dot"></span>
            <span>SYSTEM ONLINE</span>
        </div>
    </div>
</div>

<!-- Key Metrics -->
<div class="metric-grid">
    <div class="metric-card primary">
        <div class="metric-header">
            <div class="metric-icon primary">
                <i class="fas fa-door-open"></i>
            </div>
        </div>
        <div class="metric-value" id="door-status">{{ door_status }}</div>
        <div class="metric-label">Door Status</div>
    </div>

    <div class="metric-card {% if alarm_status == 'Active' %}danger{% else %}success{% endif %}">
        <div class="metric-header">
            <div class="metric-icon {% if alarm_status == 'Active' %}danger{% else %}success{% endif %}">
                <i class="fas fa-bell"></i>
            </div>
        </div>
        <div class="metric-value" id="alarm-status">{{ alarm_status }}</div>
        <div class="metric-label">Alarm Status</div>
    </div>

    <div class="metric-card warning">
        <div class="metric-header">
            <div class="metric-icon warning">
                <i class="fas fa-clock"></i>
            </div>
        </div>
        <div class="metric-value" id="timer-set">{{ timer_set }}s</div>
        <div class="metric-label">Timer Setting</div>
    </div>

    <div class="metric-card success">
        <div class="metric-header">
            <div class="metric-icon success">
                <i class="fas fa-list-ul"></i>
            </div>
        </div>
        <div class="metric-value" id="total-events">{{ total_events }}</div>
        <div class="metric-label">Total Events</div>
    </div>
</div>

<!-- Analytics & Controls -->
<div class="analytics-section">
    <!-- Statistics Card -->
    <div class="chart-card">
        <div class="card-header border-0 pb-0">
            <h3 class="card-title">
                <i class="fas fa-chart-bar"></i>
                System Analytics
            </h3>
        </div>
        <div class="row mt-4">
            <div class="col-6 col-md-3 mb-4">
                <div class="text-center">
                    <div class="metric-value text-gradient" id="door-open-events" style="font-size: 28px;">{{ door_open_events }}</div>
                    <div class="metric-label">Door Opens</div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-4">
                <div class="text-center">
                    <div class="metric-value text-gradient" id="door-close-events" style="font-size: 28px;">{{ door_close_events }}</div>
                    <div class="metric-label">Door Closes</div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-4">
                <div class="text-center">
                    <div class="metric-value text-gradient" id="alarm-events" style="font-size: 28px;">{{ alarm_events }}</div>
                    <div class="metric-label">Alarms</div>
                </div>
            </div>
            <div class="col-6 col-md-3 mb-4">
                <div class="text-center">
                    <div class="metric-value text-gradient" id="system-uptime" style="font-size: 20px;">{{ uptime.uptime_string }}</div>
                    <div class="metric-label">System Uptime</div>
                    <small class="text-muted" id="uptime-availability">{{ uptime.availability_percent }}% Available</small>
                </div>
            </div>
        </div>
    </div>

    <!-- Control Panel -->
    {% if 'controls' in permissions %}
    <div class="control-panel">
        <div class="card-header border-0 pb-0">
            <h3 class="card-title">
                <i class="fas fa-sliders-h"></i>
                Quick Actions
            </h3>
        </div>
        <div class="control-grid">
            <a href="#" class="control-button" onclick="showTimerModal(); return false;">
                <div class="control-icon primary">
                    <i class="fas fa-clock"></i>
                </div>
                <div class="control-text">
                    <div class="control-title">Set Timer</div>
                    <div class="control-desc">Configure alarm delay</div>
                </div>
                <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
            </a>

            <a href="#" class="control-button" onclick="backupDatabase(); return false;">
                <div class="control-icon success">
                    <i class="fas fa-database"></i>
                </div>
                <div class="control-text">
                    <div class="control-title">Backup Data</div>
                    <div class="control-desc">Create database backup</div>
                </div>
                <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
            </a>

            <a href="#" class="control-button" onclick="testSystem(); return false;">
                <div class="control-icon warning">
                    <i class="fas fa-vial"></i>
                </div>
                <div class="control-text">
                    <div class="control-title">System Test</div>
                    <div class="control-desc">Run diagnostics</div>
                </div>
                <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
            </a>

            <a href="{{ url_for('admin_panel') }}" class="control-button">
                <div class="control-icon danger">
                    <i class="fas fa-cog"></i>
                </div>
                <div class="control-text">
                    <div class="control-title">Settings</div>
                    <div class="control-desc">System configuration</div>
                </div>
                <i class="fas fa-chevron-right" style="color: var(--text-muted);"></i>
            </a>
        </div>
    </div>
    {% endif %}
</div>

<!-- Timer Modal -->
<div class="modal fade" id="timerModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content glass-effect">
            <div class="modal-header border-0">
                <h5 class="modal-title"><i class="fas fa-clock me-2"></i>Set Alarm Timer</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <label class="form-label">Timer Duration (seconds)</label>
                    <input type="number" class="form-control" id="timer-input" min="1" max="300" value="{{ timer_set }}" 
                           style="background: var(--glass-dark); border: 1px solid var(--glass-border); color: var(--text-primary);">
                </div>
            </div>
            <div class="modal-footer border-0">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="setTimer()">
                    <i class="fas fa-check me-2"></i>Set Timer
                </button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
// Timer Management
function showTimerModal() {
    const modal = new bootstrap.Modal(document.getElementById('timerModal'));
    modal.show();
}

function setTimer() {
    const timerValue = document.getElementById('timer-input').value;
    
    fetch('/api/settings', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ timer_duration: parseInt(timerValue) })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            document.getElementById('timer-set').textContent = timerValue + 's';
            showNotification('Timer set successfully!', 'success');
            bootstrap.Modal.getInstance(document.getElementById('timerModal')).hide();
        } else {
            showNotification('Error setting timer', 'error');
        }
    })
    .catch(error => showNotification('Error: ' + error, 'error'));
}

// Database Backup
function backupDatabase() {
    showNotification('Starting database backup...', 'info');
    
    fetch('/api/backup')
    .then(response => {
        if (response.ok) return response.blob();
        throw new Error('Backup failed');
    })
    .then(blob => {
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = `edomos_backup_${new Date().toISOString().split('T')[0]}.db`;
        a.click();
        window.URL.revokeObjectURL(url);
        showNotification('Database backup completed!', 'success');
    })
    .catch(error => showNotification('Backup failed: ' + error, 'error'));
}

// System Test
function testSystem() {
    showNotification('Running system diagnostics...', 'info');
    
    setTimeout(() => {
        showNotification('System test completed - All systems operational', 'success');
    }, 3000);
}

// Real-time Updates
class DashboardRealtime {
    constructor() {
        this.updateInterval = setInterval(() => this.fetchUpdates(), 3000);
        console.log('âœ… Dashboard real-time updates initialized');
    }
    
    async fetchUpdates() {
        try {
            const response = await fetch('/api/dashboard');
            const data = await response.json();
            
            if (data.success) {
                this.updateElements(data);
            }
        } catch (error) {
            console.error('Error fetching dashboard updates:', error);
        }
    }
    
    updateElements(data) {
        this.updateElement('door-status', data.door_status);
        this.updateElement('alarm-status', data.alarm_status);
        this.updateElement('timer-set', data.timer_set + 's');
        this.updateCounter('total-events', data.total_events);
        this.updateCounter('door-open-events', data.door_open_events);
        this.updateCounter('door-close-events', data.door_close_events);
        this.updateCounter('alarm-events', data.alarm_events);
        
        if (data.uptime) {
            this.updateElement('system-uptime', data.uptime.uptime_string);
            this.updateElement('uptime-availability', `${data.uptime.availability_percent}% Available`);
        }
    }
    
    updateElement(id, value) {
        const el = document.getElementById(id);
        if (el && el.textContent !== value) {
            el.textContent = value;
            el.classList.add('updated');
            setTimeout(() => el.classList.remove('updated'), 1000);
        }
    }
    
    updateCounter(id, newValue) {
        const el = document.getElementById(id);
        if (el) {
            const currentValue = parseInt(el.textContent) || 0;
            if (currentValue !== newValue) {
                el.textContent = newValue;
                el.classList.add('counter-updating');
                setTimeout(() => el.classList.remove('counter-updating'), 500);
            }
        }
    }
}

// Initialize
document.addEventListener('DOMContentLoaded', () => {
    new DashboardRealtime();
});
</script>
{% endblock %}
