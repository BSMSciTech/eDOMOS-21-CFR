{% extends "base.html" %}

{% block title %}Admin Panel - System Settings{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <!-- Professional Admin Header -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-md border-0">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h1 class="mb-1">
                                <i class="fas fa-user-shield text-primary me-2"></i>
                                Administration Panel
                            </h1>
                            <p class="text-muted mb-0">System Configuration & Security Settings</p>
                        </div>
                        <div class="d-flex gap-3">
                            <div class="text-center">
                                <div class="h3 mb-0 fw-bold text-primary">{{ users|length }}</div>
                                <small class="text-muted">Total Users</small>
                            </div>
                            <div class="text-center">
                                <div class="h3 mb-0 fw-bold text-success">{{ users|selectattr('is_admin')|list|length }}</div>
                                <small class="text-muted">Administrators</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Settings Section -->
    <div class="row mb-4">
        <!-- Timer Configuration -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-primary">
                    <h5 class="mb-0">
                        <i class="fas fa-clock me-2"></i>Timer Configuration
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Configure the alarm timer duration for door open events</p>
                    <form method="POST" action="{{ url_for('admin_settings') }}">
                        {{ settings_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ settings_form.timer_duration.label(class="form-label fw-bold") }}
                            <div class="input-group">
                                {{ settings_form.timer_duration(class="form-control", style="border: 2px solid var(--border-medium)") }}
                                <span class="input-group-text">seconds</span>
                            </div>
                            <small class="text-muted">How long to wait before triggering alarm when door is opened</small>
                        </div>

                        <button type="submit" class="btn btn-primary w-100">
                            <i class="fas fa-save me-2"></i>Save Timer Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Anomaly Detection Configuration -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-exclamation-triangle me-2"></i>Anomaly Detection Settings
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Configure business hours for odd-hours anomaly detection</p>
                    <form method="POST" action="{{ url_for('admin_settings') }}">
                        {{ settings_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock me-2 text-info"></i>Business Hours Start
                            </label>
                            <input type="time" class="form-control" id="businessHoursStart" name="business_hours_start" value="{{ business_hours_start or '09:00' }}" style="border: 2px solid var(--border-medium)">
                            <small class="text-muted">Start of normal business hours (24-hour format)</small>
                        </div>

                        <div class="mb-3">
                            <label class="form-label fw-bold">
                                <i class="fas fa-clock me-2 text-info"></i>Business Hours End
                            </label>
                            <input type="time" class="form-control" id="businessHoursEnd" name="business_hours_end" value="{{ business_hours_end or '17:00' }}" style="border: 2px solid var(--border-medium)">
                            <small class="text-muted">End of normal business hours (24-hour format)</small>
                        </div>

                        <button type="submit" class="btn btn-info w-100">
                            <i class="fas fa-save me-2"></i>Save Anomaly Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Email Configuration -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0 h-100">
                <div class="card-header bg-warning">
                    <h5 class="mb-0">
                        <i class="fas fa-envelope me-2"></i>Email Notification Settings
                    </h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">Configure email alerts for security events</p>
                    <form method="POST" action="{{ url_for('admin_settings') }}">
                        {{ settings_form.hidden_tag() }}
                        
                        <div class="mb-3">
                            {{ settings_form.sender_email.label(class="form-label fw-bold") }}
                            {{ settings_form.sender_email(class="form-control", placeholder="your-email@gmail.com", style="border: 2px solid var(--border-medium)") }}
                            <small class="text-muted">Gmail address for sending notifications</small>
                        </div>

                        <div class="mb-3">
                            {{ settings_form.app_password.label(class="form-label fw-bold") }}
                            {{ settings_form.app_password(class="form-control", placeholder="xxxx xxxx xxxx xxxx", style="border: 2px solid var(--border-medium)") }}
                            <small class="text-muted">
                                <a href="https://myaccount.google.com/apppasswords" target="_blank" class="text-decoration-none">
                                    Generate Gmail App Password
                                    <i class="fas fa-external-link-alt ms-1"></i>
                                </a>
                            </small>
                        </div>

                        <div class="mb-3">
                            {{ settings_form.recipient_emails.label(class="form-label fw-bold") }}
                            {{ settings_form.recipient_emails(class="form-control", placeholder="admin@example.com, security@example.com", rows=2, style="border: 2px solid var(--border-medium)") }}
                            <small class="text-muted">Comma-separated list of email addresses to receive alerts</small>
                        </div>

                        <button type="submit" class="btn btn-warning w-100">
                            <i class="fas fa-save me-2"></i>Save Email Settings
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Access Links Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card shadow-sm border-0">
                <div class="card-header bg-success">
                    <h5 class="mb-0">
                        <i class="fas fa-link me-2"></i>Quick Access Links
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <!-- User Management -->
                        <div class="col-md-4">
                            <a href="{{ url_for('user_management') }}" class="text-decoration-none">
                                <div class="card border-primary h-100 hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-users fa-3x text-primary mb-3"></i>
                                        <h5 class="card-title">User Management</h5>
                                        <p class="card-text text-muted">Create, edit, and manage user accounts & profiles</p>
                                    </div>
                                </div>
                            </a>
                        </div>

                        <!-- Company Profile -->
                        <div class="col-md-4">
                            <a href="{{ url_for('company_profile') }}" class="text-decoration-none">
                                <div class="card border-warning h-100 hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-building fa-3x text-warning mb-3"></i>
                                        <h5 class="card-title">Company Profile</h5>
                                        <p class="card-text text-muted">Update company info, logo & door system details</p>
                                    </div>
                                </div>
                            </a>
                        </div>

                        <!-- System Logs -->
                        <div class="col-md-4">
                            <a href="{{ url_for('event_log') }}" class="text-decoration-none">
                                <div class="card border-success h-100 hover-card">
                                    <div class="card-body text-center">
                                        <i class="fas fa-file-alt fa-3x text-success mb-3"></i>
                                        <h5 class="card-title">Event Logs</h5>
                                        <p class="card-text text-muted">View system events and security logs</p>
                                    </div>
                                </div>
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- System Information Section -->
    <div class="row">
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header" style="background: var(--gradient-dark); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle me-2"></i>System Information
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <td class="fw-bold text-muted">System Version:</td>
                                <td>eDOMOS v2.1</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">Database:</td>
                                <td>SQLite</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">Server Status:</td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i>Running
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">GPIO Status:</td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-microchip me-1"></i>Active
                                    </span>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Security Status -->
        <div class="col-lg-6 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header" style="background: var(--gradient-danger); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-shield-alt me-2"></i>Security Status
                    </h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tbody>
                            <tr>
                                <td class="fw-bold text-muted">Authentication:</td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-lock me-1"></i>Enabled
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">Password Hashing:</td>
                                <td>
                                    <span class="badge bg-success">
                                        <i class="fas fa-key me-1"></i>bcrypt
                                    </span>
                                </td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">Active Sessions:</td>
                                <td>{{ users|length }}</td>
                            </tr>
                            <tr>
                                <td class="fw-bold text-muted">Last Login:</td>
                                <td>{{ current_user.last_login.strftime('%Y-%m-%d %H:%M') if current_user.last_login else 'N/A' }}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- IP Address Restriction Section -->
    <div class="row">
        <div class="col-12 mb-4">
            <div class="card shadow-sm border-0">
                <div class="card-header" style="background: var(--gradient-security); color: white;">
                    <h5 class="mb-0">
                        <i class="fas fa-network-wired me-2"></i>IP Address Restrictions
                    </h5>
                </div>
                <div class="card-body">
                    <form method="POST" action="{{ url_for('ip_settings') }}">
                        
                        <!-- Enable/Disable IP Restrictions -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="form-check form-switch">
                                    <input type="checkbox" class="form-check-input" id="ip_restriction_enabled" 
                                           name="ip_restriction_enabled" 
                                           {% if ip_settings.get('ip_restriction_enabled', 'false').lower() == 'true' %}checked{% endif %}>
                                    <label class="form-check-label fw-bold" for="ip_restriction_enabled">
                                        <i class="fas fa-shield-alt me-2"></i>Enable IP Address Restrictions
                                    </label>
                                    <div class="form-text">
                                        When enabled, only IP addresses in the whitelist (if configured) will be allowed to access the system.
                                        Blacklisted IPs will always be blocked.
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Current IP Address Display -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="alert alert-info d-flex align-items-center">
                                    <i class="fas fa-info-circle me-2"></i>
                                    <div>
                                        <strong>Your current IP address:</strong> 
                                        <code id="current-ip">{{ current_ip }}</code>
                                        <br>
                                        <small class="text-muted">Make sure to include your IP in the whitelist before enabling restrictions to avoid being locked out.</small>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row">
                            <!-- IP Whitelist -->
                            <div class="col-md-6 mb-3">
                                <label for="ip_whitelist" class="form-label fw-bold">
                                    <i class="fas fa-check-circle text-success me-2"></i>IP Whitelist
                                </label>
                                <textarea name="ip_whitelist" id="ip_whitelist" 
                                          class="form-control" rows="6" 
                                          placeholder="192.168.1.100&#10;10.0.0.0/24&#10;172.16.0.1"
                                          style="border: 2px solid var(--border-medium); font-family: monospace;">{{ ip_settings.get('ip_whitelist', '') }}</textarea>
                                <div class="form-text">
                                    Enter allowed IP addresses, one per line. Supports single IPs (192.168.1.100) and CIDR notation (192.168.1.0/24).
                                    If empty, all IPs are allowed (except blacklisted ones).
                                </div>
                            </div>

                            <!-- IP Blacklist -->
                            <div class="col-md-6 mb-3">
                                <label for="ip_blacklist" class="form-label fw-bold">
                                    <i class="fas fa-times-circle text-danger me-2"></i>IP Blacklist
                                </label>
                                <textarea name="ip_blacklist" id="ip_blacklist" 
                                          class="form-control" rows="6" 
                                          placeholder="192.168.1.50&#10;10.0.0.0/8&#10;172.16.1.100"
                                          style="border: 2px solid var(--border-medium); font-family: monospace;">{{ ip_settings.get('ip_blacklist', '') }}</textarea>
                                <div class="form-text">
                                    Enter blocked IP addresses, one per line. These IPs will always be denied access.
                                    Supports single IPs and CIDR notation.
                                </div>
                            </div>
                        </div>

                        <!-- Quick Actions -->
                        <div class="row mb-3">
                            <div class="col-md-12">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-sm btn-outline-success" onclick="addCurrentIP('whitelist')">
                                        <i class="fas fa-plus me-1"></i>Add Current IP to Whitelist
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info" onclick="addLocalNetwork()">
                                        <i class="fas fa-home me-1"></i>Add Local Network (192.168.0.0/16)
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-warning" onclick="clearList('whitelist')">
                                        <i class="fas fa-eraser me-1"></i>Clear Whitelist
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-danger" onclick="clearList('blacklist')">
                                        <i class="fas fa-eraser me-1"></i>Clear Blacklist
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="row">
                            <div class="col-md-12">
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-save me-2"></i>Save IP Restrictions
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
/* Custom styling for this page */
.hover-card {
    transition: all var(--transition-base);
    cursor: pointer;
}

.hover-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15) !important;
}

.card-header.bg-primary,
.card-header.bg-success,
.card-header.bg-warning,
.card-header.bg-danger {
    background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%) !important;
}

.card-header.bg-info {
    background: linear-gradient(135deg, var(--info) 0%, #0dcaf0 100%) !important;
}

/* Enhanced gradient styles */
:root {
    --gradient-security: linear-gradient(135deg, #6f42c1 0%, #495057 100%);
}

/* Time input styling with enhanced clock icons */
input[type="time"] {
    position: relative;
}

input[type="time"]::-webkit-calendar-picker-indicator {
    background: #007bff;
    border-radius: 50%;
    color: white;
    font-size: 14px;
    width: 20px;
    height: 20px;
    display: flex;
    align-items: center;
    justify-content: center;
}

input[type="time"]::-webkit-calendar-picker-indicator:hover {
    background: #0056b3;
    cursor: pointer;
}

/* For Firefox */
input[type="time"]::-moz-calendar-picker {
    background: #007bff;
    border-radius: 50%;
    color: white;
}
</style>

<script>
// Form validation and user feedback
document.addEventListener('DOMContentLoaded', function() {
    // Add success message if settings were saved
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success') === 'true') {
        showAlert('Settings saved successfully!', 'success');
    }
    
    // Check for flash messages and display them
    {% with messages = get_flashed_messages(with_categories=true) %}
        {% if messages %}
            {% for category, message in messages %}
                showAlert('{{ message }}', '{{ 'success' if category == 'success' else 'danger' if category == 'error' else 'warning' }}');
            {% endfor %}
        {% endif %}
    {% endwith %}
    
    // Form validation
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', function(e) {
            const submitBtn = form.querySelector('button[type="submit"]');
            if (submitBtn) {
                submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Saving...';
                submitBtn.disabled = true;
            }
        });
    });
});

function showAlert(message, type) {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    document.querySelector('.container-fluid').insertBefore(alertDiv, document.querySelector('.row'));
    
    setTimeout(() => {
        alertDiv.remove();
    }, 5000);
}

// IP Management Functions
function addCurrentIP(listType) {
    const currentIP = document.getElementById('current-ip').textContent;
    const textarea = document.getElementById(`ip_${listType}`);
    const currentValue = textarea.value.trim();
    
    // Check if IP is already in the list
    if (currentValue.includes(currentIP)) {
        showAlert(`Current IP ${currentIP} is already in the ${listType}`, 'warning');
        return;
    }
    
    // Add the IP to the list
    const newValue = currentValue ? `${currentValue}\n${currentIP}` : currentIP;
    textarea.value = newValue;
    showAlert(`Added current IP ${currentIP} to ${listType}`, 'success');
}

function addLocalNetwork() {
    const textarea = document.getElementById('ip_whitelist');
    const localNetwork = '192.168.0.0/16';
    const currentValue = textarea.value.trim();
    
    // Check if local network is already in the list
    if (currentValue.includes(localNetwork)) {
        showAlert('Local network 192.168.0.0/16 is already in the whitelist', 'warning');
        return;
    }
    
    // Add the local network to the whitelist
    const newValue = currentValue ? `${currentValue}\n${localNetwork}` : localNetwork;
    textarea.value = newValue;
    showAlert('Added local network 192.168.0.0/16 to whitelist', 'success');
}

function clearList(listType) {
    if (confirm(`Are you sure you want to clear the ${listType}? This action cannot be undone.`)) {
        document.getElementById(`ip_${listType}`).value = '';
        showAlert(`${listType.charAt(0).toUpperCase() + listType.slice(1)} cleared`, 'info');
    }
}
</script>
{% endblock %}
