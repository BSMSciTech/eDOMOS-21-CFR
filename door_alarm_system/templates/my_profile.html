{% extends "base.html" %}

{% block title %}My Profile - eDOMOS{% endblock %}

{% block content %}
<div class="container-fluid mt-4">
    <div class="row">
        <div class="col-12">
            <div class="card bg-dark text-light">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h4 class="mb-0">
                        <i class="fas fa-id-card me-2"></i>My Profile
                    </h4>
                </div>
                <div class="card-body">
                    <!-- Alert Messages -->
                    <div id="profileAlert" class="alert d-none" role="alert"></div>
                    
                    <form id="profileForm">
                        <div class="row">
                            <!-- Left Column -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="username" class="form-label">
                                        <i class="fas fa-user me-1"></i>Username
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="username" readonly>
                                    <small class="text-muted">Username cannot be changed</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="fullName" class="form-label">
                                        <i class="fas fa-id-badge me-1"></i>Full Name
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="fullName" placeholder="Enter your full name">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="email" class="form-label">
                                        <i class="fas fa-envelope me-1"></i>Email
                                    </label>
                                    <input type="email" class="form-control bg-dark text-light" id="email" placeholder="your.email@example.com">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="phone" class="form-label">
                                        <i class="fas fa-phone me-1"></i>Phone
                                    </label>
                                    <input type="tel" class="form-control bg-dark text-light" id="phone" placeholder="+1-234-567-8900">
                                </div>
                            </div>
                            
                            <!-- Right Column -->
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label for="employeeId" class="form-label">
                                        <i class="fas fa-hashtag me-1"></i>Employee ID
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="employeeId" readonly>
                                    <small class="text-muted">Contact admin to change</small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="department" class="form-label">
                                        <i class="fas fa-building me-1"></i>Department
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="department" placeholder="Your department">
                                    <small class="text-muted" id="departmentHelp"></small>
                                </div>
                                
                                <div class="mb-3">
                                    <label for="role" class="form-label">
                                        <i class="fas fa-briefcase me-1"></i>Role/Position
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="role" placeholder="Your role">
                                    <small class="text-muted" id="roleHelp"></small>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-calendar me-1"></i>Account Created
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="createdAt" readonly>
                                </div>
                                
                                <div class="mb-3">
                                    <label class="form-label">
                                        <i class="fas fa-sign-in-alt me-1"></i>Last Login
                                    </label>
                                    <input type="text" class="form-control bg-dark text-light" id="lastLogin" readonly>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Admin Badge -->
                        <div class="mb-3" id="adminBadgeContainer" style="display: none;">
                            <span class="badge bg-danger fs-6">
                                <i class="fas fa-shield-alt me-1"></i>Administrator Account
                            </span>
                        </div>
                        
                        <!-- Permissions -->
                        <div class="mb-3">
                            <label class="form-label">
                                <i class="fas fa-key me-1"></i>Permissions
                            </label>
                            <div id="permissionsList" class="d-flex flex-wrap gap-2"></div>
                        </div>
                        
                        <div class="d-flex justify-content-end gap-2">
                            <button type="button" class="btn btn-secondary" onclick="window.location.href='{{ url_for('dashboard') }}'">
                                <i class="fas fa-times me-1"></i>Cancel
                            </button>
                            <button type="submit" class="btn btn-primary">
                                <i class="fas fa-save me-1"></i>Save Changes
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    loadProfile();
    
    // Form submission
    document.getElementById('profileForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        await updateProfile();
    });
});

async function loadProfile() {
    try {
        const response = await fetch('/api/my-profile');
        const data = await response.json();
        
        if (data.success) {
            const profile = data.profile;
            
            // Populate form fields
            document.getElementById('username').value = profile.username || '';
            document.getElementById('fullName').value = profile.full_name || '';
            document.getElementById('email').value = profile.email || '';
            document.getElementById('phone').value = profile.phone || '';
            document.getElementById('employeeId').value = profile.employee_id || '';
            document.getElementById('department').value = profile.department || '';
            document.getElementById('role').value = profile.role || '';
            document.getElementById('createdAt').value = profile.created_at || 'N/A';
            document.getElementById('lastLogin').value = profile.last_login || 'Never';
            
            // Show admin badge if admin
            if (profile.is_admin) {
                document.getElementById('adminBadgeContainer').style.display = 'block';
                document.getElementById('departmentHelp').textContent = 'Admins can edit';
                document.getElementById('roleHelp').textContent = 'Admins can edit';
            } else {
                document.getElementById('department').readOnly = true;
                document.getElementById('role').readOnly = true;
                document.getElementById('departmentHelp').textContent = 'Contact admin to change';
                document.getElementById('roleHelp').textContent = 'Contact admin to change';
            }
            
            // Display permissions
            const permissionsList = document.getElementById('permissionsList');
            permissionsList.innerHTML = '';
            
            const permissionLabels = {
                'dashboard': 'Dashboard',
                'controls': 'Controls',
                'event_log': 'Event Log',
                'report': 'Reports',
                'analytics': 'Analytics',
                'admin': 'Admin'
            };
            
            // Get permissions - handle both string and boolean values
            let permissions = [];
            if (typeof profile.permissions === 'string') {
                permissions = profile.permissions.split(',').map(p => p.trim()).filter(p => p);
            }
            
            if (profile.is_admin) {
                permissions = ['dashboard', 'controls', 'event_log', 'report', 'analytics', 'admin'];
            }
            
            permissions.forEach(perm => {
                const badge = document.createElement('span');
                badge.className = 'badge bg-info';
                badge.innerHTML = `<i class="fas fa-check me-1"></i>${permissionLabels[perm] || perm}`;
                permissionsList.appendChild(badge);
            });
        } else {
            showAlert('Error loading profile', 'danger');
        }
    } catch (error) {
        console.error('Error loading profile:', error);
        showAlert('Failed to load profile', 'danger');
    }
}

async function updateProfile() {
    try {
        const profileData = {
            full_name: document.getElementById('fullName').value,
            email: document.getElementById('email').value,
            phone: document.getElementById('phone').value,
            department: document.getElementById('department').value,
            role: document.getElementById('role').value
        };
        
        const response = await fetch('/api/my-profile', {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(profileData)
        });
        
        const data = await response.json();
        
        if (data.success) {
            showAlert(data.message, 'success');
            setTimeout(() => loadProfile(), 1500);
        } else {
            showAlert(data.error || 'Failed to update profile', 'danger');
        }
    } catch (error) {
        console.error('Error updating profile:', error);
        showAlert('Failed to update profile', 'danger');
    }
}

function showAlert(message, type) {
    const alert = document.getElementById('profileAlert');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;
    alert.classList.remove('d-none');
    
    setTimeout(() => {
        alert.classList.add('d-none');
    }, 5000);
}
</script>
{% endblock %}
