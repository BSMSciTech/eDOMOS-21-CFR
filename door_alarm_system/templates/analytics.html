{% extends "base.html" %}

{% block title %}Door Usage Analytics{% endblock %}

{% block content %}
<div class="container-fluid">
    <!-- Header -->
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="fas fa-chart-line me-2"></i>Door Usage Analytics</h2>
            <p class="text-muted">Comprehensive analysis of door usage patterns and statistics</p>
        </div>
    </div>

    <!-- Time Range Selector -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="btn-group" role="group">
                <a href="?range=day" class="btn btn-outline-primary {% if time_range == 'day' %}active{% endif %}">
                    <i class="fas fa-calendar-day me-1"></i>Today
                </a>
                <a href="?range=week" class="btn btn-outline-primary {% if time_range == 'week' %}active{% endif %}">
                    <i class="fas fa-calendar-week me-1"></i>Last 7 Days
                </a>
                <a href="?range=month" class="btn btn-outline-primary {% if time_range == 'month' or not time_range %}active{% endif %}">
                    <i class="fas fa-calendar-alt me-1"></i>Last 30 Days
                </a>
            </div>
        </div>
    </div>

    <!-- KPI Cards - Door Open Counts -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card bg-gradient-primary text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Today's Door Opens</h6>
                            <h2 class="mb-0 fw-bold" id="door-open-day">{{ door_open_count_day }}</h2>
                        </div>
                        <div class="icon-circle bg-white bg-opacity-25">
                            <i class="fas fa-door-open fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card bg-gradient-info text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Last 7 Days Opens</h6>
                            <h2 class="mb-0 fw-bold" id="door-open-week">{{ door_open_count_week }}</h2>
                        </div>
                        <div class="icon-circle bg-white bg-opacity-25">
                            <i class="fas fa-calendar-week fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card bg-gradient-success text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Last 30 Days Opens</h6>
                            <h2 class="mb-0 fw-bold" id="door-open-month">{{ door_open_count_month }}</h2>
                        </div>
                        <div class="icon-circle bg-white bg-opacity-25">
                            <i class="fas fa-calendar-alt fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Duration Statistics -->
    <div class="row mb-4">
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card border-warning h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-clock text-warning me-2"></i>Average Open Duration
                            </h6>
                            <h3 class="mb-0 fw-bold text-warning">
                                {% if avg_open_duration < 60 %}
                                    {{ "%.1f"|format(avg_open_duration) }} sec
                                {% else %}
                                    {{ "%.1f"|format(avg_open_duration / 60) }} min
                                {% endif %}
                            </h3>
                            <small class="text-muted">Mean time door remains open per event</small>
                        </div>
                        <div class="icon-circle bg-warning bg-opacity-10">
                            <i class="fas fa-stopwatch fa-2x text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-6 col-md-6 mb-3">
            <div class="card border-danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-muted mb-2">
                                <i class="fas fa-exclamation-triangle text-danger me-2"></i>Maximum Open Duration
                            </h6>
                            <h3 class="mb-0 fw-bold text-danger">
                                {% if max_open_duration < 60 %}
                                    {{ "%.1f"|format(max_open_duration) }} sec
                                {% else %}
                                    {{ "%.1f"|format(max_open_duration / 60) }} min
                                {% endif %}
                            </h3>
                            <small class="text-muted">Longest open period recorded</small>
                        </div>
                        <div class="icon-circle bg-danger bg-opacity-10">
                            <i class="fas fa-hourglass-end fa-2x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Row -->
    <div class="row mb-4">
        <!-- Duration Distribution Histogram -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-gradient-primary text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Door Open Duration Distribution
                    </h5>
                    <small>Frequency of door opens within duration bands</small>
                </div>
                <div class="card-body">
                    <canvas id="durationHistogram"></canvas>
                </div>
            </div>
        </div>

        <!-- Open vs Closed Percentage -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-gradient-success text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-pie-chart me-2"></i>Door Open vs Closed Time
                    </h5>
                    <small>Ratio of open vs closed state over monitoring period</small>
                </div>
                <div class="card-body">
                    <canvas id="openClosedPieChart"></canvas>
                    <div class="text-center mt-3">
                        <div class="row">
                            <div class="col-6">
                                <h4 class="text-success mb-0">{{ closed_percentage }}%</h4>
                                <small class="text-muted">Closed Time</small>
                            </div>
                            <div class="col-6">
                                <h4 class="text-danger mb-0">{{ open_percentage }}%</h4>
                                <small class="text-muted">Open Time</small>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Daily Opens Trend -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-line-chart me-2"></i>Daily Door Opens Trend
                    </h5>
                    <small>Number of door open events per day</small>
                </div>
                <div class="card-body">
                    <canvas id="dailyOpensChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Statistics Table -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-dark text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-table me-2"></i>Duration Band Summary
                    </h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead>
                                <tr>
                                    <th>Duration Band</th>
                                    <th>Frequency</th>
                                    <th>Percentage</th>
                                    <th>Visual</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% set total_events = duration_buckets.values()|sum %}
                                {% for band, count in duration_buckets.items() %}
                                <tr>
                                    <td><strong>{{ band }}</strong></td>
                                    <td>{{ count }}</td>
                                    <td>
                                        {% if total_events > 0 %}
                                            {{ "%.1f"|format((count / total_events) * 100) }}%
                                        {% else %}
                                            0%
                                        {% endif %}
                                    </td>
                                    <td>
                                        {% if total_events > 0 %}
                                            {% set percentage = (count / total_events) * 100 %}
                                        {% else %}
                                            {% set percentage = 0 %}
                                        {% endif %}
                                        <div class="progress" style="height: 25px;">
                                            <div class="progress-bar bg-info" role="progressbar" 
                                                 style="width: {{ percentage }}%">
                                                {{ count }}
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- ALARM EVENT ANALYSIS -->
    <!-- ============================================ -->
    <div class="row mb-3">
        <div class="col-12">
            <h3 class="text-warning"><i class="fas fa-bell me-2"></i>Alarm Event Analysis</h3>
            <p class="text-muted">Comprehensive analysis of alarm triggers and response patterns</p>
            <hr>
        </div>
    </div>

    <!-- Alarm KPI Cards -->
    <div class="row mb-4">
        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-danger text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Total Alarms Triggered</h6>
                            <h2 class="mb-0 fw-bold" id="total-alarms">{{ total_alarms }}</h2>
                            <small>In selected period</small>
                        </div>
                        <div class="icon-circle bg-white bg-opacity-25">
                            <i class="fas fa-bell fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-gradient-warning text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Avg Alarm Duration</h6>
                            <h2 class="mb-0 fw-bold" id="avg-alarm-duration">
                                {% if avg_alarm_duration < 60 %}
                                    {{ "%.1f"|format(avg_alarm_duration) }}s
                                {% else %}
                                    {{ "%.1f"|format(avg_alarm_duration / 60) }}m
                                {% endif %}
                            </h2>
                            <small>Time between alarm and door close</small>
                        </div>
                        <div class="icon-circle bg-white bg-opacity-25">
                            <i class="fas fa-clock fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card bg-gradient-danger text-white h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-white-50 mb-2">Longest Alarm</h6>
                            <h2 class="mb-0 fw-bold" id="longest-alarm">
                                {% if longest_alarm_duration < 60 %}
                                    {{ "%.1f"|format(longest_alarm_duration) }}s
                                {% else %}
                                    {{ "%.1f"|format(longest_alarm_duration / 60) }}m
                                {% endif %}
                            </h2>
                            <small>Maximum duration of active alarm</small>
                        </div>
                        <div class="icon-circle bg-white bg-opacity-25">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-3 col-md-6 mb-3">
            <div class="card border-danger h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-danger mb-2">
                                <i class="fas fa-user-clock text-danger me-2"></i>Unacknowledged Alarms
                            </h6>
                            <h2 class="mb-0 fw-bold text-danger" id="unack-alarms">{{ unacknowledged_alarms }}</h2>
                            <small class="text-muted">Not resolved within {{ alarm_threshold * 2 }}s threshold</small>
                        </div>
                        <div class="icon-circle bg-danger bg-opacity-10">
                            <i class="fas fa-times-circle fa-2x text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alarm Charts -->
    <div class="row mb-4">
        <!-- Daily Alarm Trend -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-area me-2"></i>Daily Alarm Trend
                    </h5>
                    <small>Number of alarms triggered per day</small>
                </div>
                <div class="card-body">
                    <canvas id="dailyAlarmsChart"></canvas>
                </div>
            </div>
        </div>

        <!-- Acknowledgement Response Time Trend -->
        <div class="col-lg-6 mb-4">
            <div class="card h-100">
                <div class="card-header bg-warning text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-user-check me-2"></i>Response Time Trend
                    </h5>
                    <small>Average time to respond to alarms (door close)</small>
                </div>
                <div class="card-body">
                    <canvas id="responseTimeChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <!-- ============================================ -->
    <!-- PERFORMANCE TRENDS AND KPIs -->
    <!-- ============================================ -->
    <div class="row mb-3">
        <div class="col-12">
            <h3 class="text-success"><i class="fas fa-chart-line me-2"></i>Performance Trends & KPIs</h3>
            <p class="text-muted">Key performance indicators and operational efficiency metrics</p>
            <hr>
        </div>
    </div>

    <!-- Performance KPI Cards -->
    <div class="row mb-4">
        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card border-primary h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-primary mb-2">
                                <i class="fas fa-wrench text-primary me-2"></i>MTTR (Mean Time To Resolve)
                            </h6>
                            <h2 class="mb-0 fw-bold text-primary" id="mttr-value">
                                {% if mttr < 60 %}
                                    {{ "%.1f"|format(mttr) }}s
                                {% else %}
                                    {{ "%.1f"|format(mttr / 60) }}m
                                {% endif %}
                            </h2>
                            <small class="text-muted">Average time from alarm to door closure</small>
                        </div>
                        <div class="icon-circle bg-primary bg-opacity-10">
                            <i class="fas fa-hourglass-half fa-2x text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card border-success h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-success mb-2">
                                <i class="fas fa-check-circle text-success me-2"></i>Compliance %
                            </h6>
                            <h2 class="mb-0 fw-bold text-success" id="compliance-percent">{{ compliance_percentage }}%</h2>
                            <small class="text-muted">Door events within allowed duration ({{ alarm_threshold * 2 }}s)</small>
                        </div>
                        <div class="icon-circle bg-success bg-opacity-10">
                            <i class="fas fa-thumbs-up fa-2x text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="col-lg-4 col-md-6 mb-3">
            <div class="card border-info h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="text-info mb-2">
                                <i class="fas fa-arrow-trend-down text-info me-2"></i>Alarm Reduction Trend
                            </h6>
                            <h2 class="mb-0 fw-bold {% if alarm_reduction_percent > 0 %}text-success{% else %}text-danger{% endif %}" id="alarm-reduction">
                                {% if alarm_reduction_percent > 0 %}
                                    <i class="fas fa-arrow-down me-1"></i><span id="alarm-reduction-value">{{ alarm_reduction_percent }}</span>%
                                {% else %}
                                    <i class="fas fa-arrow-up me-1"></i><span id="alarm-reduction-value">{{ alarm_reduction_percent|abs }}</span>%
                                {% endif %}
                            </h2>
                            <small class="text-muted">Current week vs previous week</small>
                        </div>
                        <div class="icon-circle bg-info bg-opacity-10">
                            <i class="fas fa-chart-line fa-2x text-info"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alarm Reduction Trend Chart -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-gradient-info text-white">
                    <h5 class="mb-0">
                        <i class="fas fa-chart-bar me-2"></i>Weekly Alarm Reduction Comparison
                    </h5>
                    <small>Compare alarm counts over 4-week period</small>
                </div>
                <div class="card-body">
                    <canvas id="alarmReductionChart"></canvas>
                </div>
            </div>
        </div>
    </div>

</div>

<style>
/* Gradient backgrounds */
.bg-gradient-primary {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
}

.bg-gradient-info {
    background: linear-gradient(135deg, #0093E9 0%, #80D0C7 100%);
}

.bg-gradient-success {
    background: linear-gradient(135deg, #10b981 0%, #059669 100%);
}

.bg-gradient-dark {
    background: linear-gradient(135deg, #434343 0%, #000000 100%);
}

/* Icon circles */
.icon-circle {
    width: 60px;
    height: 60px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
}

/* Card hover effects */
.card {
    transition: transform 0.2s ease-in-out, box-shadow 0.2s ease-in-out;
}

.card:hover {
    transform: translateY(-5px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.2);
}

/* Chart containers */
.card-body canvas {
    max-height: 350px;
}

/* Table styling for dark theme */
.table {
    color: #f8fafc;
}

.table thead th {
    color: #f8fafc;
    border-bottom: 2px solid #4a5568;
}

.table tbody td {
    color: #e2e8f0;
    border-bottom: 1px solid #2d3748;
}

.table-striped tbody tr:nth-of-type(odd) {
    background-color: rgba(255, 255, 255, 0.02);
}

.table-hover tbody tr:hover {
    background-color: rgba(255, 255, 255, 0.05);
}

/* Progress bars */
.progress {
    background-color: rgba(255, 255, 255, 0.1);
}

/* Time range selector */
.btn-outline-primary.active {
    background-color: var(--primary-500);
    border-color: var(--primary-500);
    color: white;
}

/* Dark theme enhancements */
.report-section h6,
.report-section p,
.report-section strong,
.report-section td,
.report-section th,
.report-section label {
    color: #fff !important;
}

.report-section .text-muted {
    color: #aaa !important;
}

.report-section a {
    color: #667eea !important;
}

.report-section .table {
    background: transparent !important;
    color: #fff !important;
}

.report-section .table thead th {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%) !important;
    border-color: rgba(138, 43, 226, 0.5) !important;
    color: #fff !important;
    font-weight: 600 !important;
    padding: 12px !important;
}

.report-section .table tbody td {
    border-color: rgba(138, 43, 226, 0.2) !important;
    color: #fff !important;
    background: transparent !important;
}

.report-section .table-hover tbody tr:hover {
    background: rgba(102, 126, 234, 0.1) !important;
}

.report-section .card {
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%) !important;
    border: 1px solid var(--border-purple) !important;
}

.report-section .card-body {
    color: #fff !important;
}

.report-section .card-body h3,
.report-section .card-body p {
    color: #fff !important;
}

</style>

<script src="https://cdn.jsdelivr.net/npm/chart.js@3.9.1/dist/chart.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Chart.js global configuration
    Chart.defaults.color = '#e2e8f0';
    Chart.defaults.borderColor = 'rgba(255, 255, 255, 0.1)';
    
    // 1. Duration Distribution Histogram
    const durationCtx = document.getElementById('durationHistogram').getContext('2d');
    new Chart(durationCtx, {
        type: 'bar',
        data: {
            labels: [
                '0-5s', '5-10s', '10-30s', '30-60s', 
                '1-2min', '2-5min', '5-10min', '10+min'
            ],
            datasets: [{
                label: 'Number of Events',
                data: [
                    {{ duration_buckets['0-5s'] }},
                    {{ duration_buckets['5-10s'] }},
                    {{ duration_buckets['10-30s'] }},
                    {{ duration_buckets['30-60s'] }},
                    {{ duration_buckets['1-2min'] }},
                    {{ duration_buckets['2-5min'] }},
                    {{ duration_buckets['5-10min'] }},
                    {{ duration_buckets['10+min'] }}
                ],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(99, 102, 241, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(168, 85, 247, 0.8)',
                    'rgba(236, 72, 153, 0.8)',
                    'rgba(251, 146, 60, 0.8)',
                    'rgba(245, 158, 11, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(99, 102, 241, 1)',
                    'rgba(139, 92, 246, 1)',
                    'rgba(168, 85, 247, 1)',
                    'rgba(236, 72, 153, 1)',
                    'rgba(251, 146, 60, 1)',
                    'rgba(245, 158, 11, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // 2. Open vs Closed Pie Chart
    const pieCtx = document.getElementById('openClosedPieChart').getContext('2d');
    new Chart(pieCtx, {
        type: 'doughnut',
        data: {
            labels: ['Closed Time', 'Open Time'],
            datasets: [{
                data: [{{ closed_percentage }}, {{ open_percentage }}],
                backgroundColor: [
                    'rgba(16, 185, 129, 0.8)',
                    'rgba(239, 68, 68, 0.8)'
                ],
                borderColor: [
                    'rgba(16, 185, 129, 1)',
                    'rgba(239, 68, 68, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: {
                        color: '#e2e8f0',
                        padding: 15,
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            return context.label + ': ' + context.parsed.toFixed(2) + '%';
                        }
                    }
                }
            }
        }
    });

    // 3. Daily Opens Line Chart
    const dailyCtx = document.getElementById('dailyOpensChart').getContext('2d');
    new Chart(dailyCtx, {
        type: 'line',
        data: {
            labels: [
                {% for day, count in daily_opens %}
                    '{{ day }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Door Opens',
                data: [
                    {% for day, count in daily_opens %}
                        {{ count }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(59, 130, 246, 0.2)',
                borderColor: 'rgba(59, 130, 246, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#e2e8f0',
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    });

    // ============================================
    // ALARM EVENT ANALYSIS CHARTS
    // ============================================

    // 4. Daily Alarms Chart
    const dailyAlarmsCtx = document.getElementById('dailyAlarmsChart').getContext('2d');
    new Chart(dailyAlarmsCtx, {
        type: 'line',
        data: {
            labels: [
                {% for day, count in daily_alarms %}
                    '{{ day }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Alarms Triggered',
                data: [
                    {% for day, count in daily_alarms %}
                        {{ count }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(239, 68, 68, 0.2)',
                borderColor: 'rgba(239, 68, 68, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(239, 68, 68, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#e2e8f0',
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    });

    // 5. Response Time Trend Chart
    const responseTimeCtx = document.getElementById('responseTimeChart').getContext('2d');
    new Chart(responseTimeCtx, {
        type: 'line',
        data: {
            labels: [
                {% for rt in response_time_trend %}
                    '{{ rt.date }}'{% if not loop.last %},{% endif %}
                {% endfor %}
            ],
            datasets: [{
                label: 'Avg Response Time (seconds)',
                data: [
                    {% for rt in response_time_trend %}
                        {{ rt.avg_response_time }}{% if not loop.last %},{% endif %}
                    {% endfor %}
                ],
                backgroundColor: 'rgba(251, 191, 36, 0.2)',
                borderColor: 'rgba(251, 191, 36, 1)',
                borderWidth: 3,
                fill: true,
                tension: 0.4,
                pointRadius: 5,
                pointHoverRadius: 7,
                pointBackgroundColor: 'rgba(251, 191, 36, 1)',
                pointBorderColor: '#fff',
                pointBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: true,
                    labels: {
                        color: '#e2e8f0',
                        font: {
                            size: 14
                        }
                    }
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1,
                    callbacks: {
                        label: function(context) {
                            let value = context.parsed.y;
                            if (value < 60) {
                                return context.dataset.label + ': ' + value.toFixed(1) + 's';
                            } else {
                                return context.dataset.label + ': ' + (value / 60).toFixed(1) + 'm';
                            }
                        }
                    }
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        color: '#e2e8f0',
                        callback: function(value) {
                            if (value < 60) {
                                return value + 's';
                            } else {
                                return (value / 60).toFixed(1) + 'm';
                            }
                        }
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                }
            }
        }
    });

    // ============================================
    // PERFORMANCE TRENDS AND KPIs CHARTS
    // ============================================

    // 6. Alarm Reduction Trend Chart
    const alarmReductionCtx = document.getElementById('alarmReductionChart').getContext('2d');
    new Chart(alarmReductionCtx, {
        type: 'bar',
        data: {
            labels: ['Current Week', 'Last Week', '2 Weeks Ago', '3 Weeks Ago'],
            datasets: [{
                label: 'Alarms Count',
                data: [
                    {{ alarm_reduction_data.week_1 }},
                    {{ alarm_reduction_data.week_2 }},
                    {{ alarm_reduction_data.week_3 }},
                    {{ alarm_reduction_data.week_4 }}
                ],
                backgroundColor: [
                    'rgba(59, 130, 246, 0.8)',
                    'rgba(99, 102, 241, 0.8)',
                    'rgba(139, 92, 246, 0.8)',
                    'rgba(168, 85, 247, 0.8)'
                ],
                borderColor: [
                    'rgba(59, 130, 246, 1)',
                    'rgba(99, 102, 241, 1)',
                    'rgba(139, 92, 246, 1)',
                    'rgba(168, 85, 247, 1)'
                ],
                borderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: {
                    display: false
                },
                tooltip: {
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    titleColor: '#fff',
                    bodyColor: '#fff',
                    borderColor: 'rgba(255, 255, 255, 0.2)',
                    borderWidth: 1
                }
            },
            scales: {
                y: {
                    beginAtZero: true,
                    ticks: {
                        stepSize: 1,
                        color: '#e2e8f0'
                    },
                    grid: {
                        color: 'rgba(255, 255, 255, 0.05)'
                    }
                },
                x: {
                    ticks: {
                        color: '#e2e8f0'
                    },
                    grid: {
                        display: false
                    }
                }
            }
        }
    });

    // ============================================
    // REAL-TIME UPDATES VIA WEBSOCKET
    // ============================================

    // Connect to Socket.IO for real-time updates
    const socket = io('/events');
    
    // Handle connection
    socket.on('connect', function() {
        console.log('[ANALYTICS] WebSocket connected');
        socket.emit('client_ready', {
            timestamp: new Date().toISOString(),
            page: '/analytics',
            userAgent: navigator.userAgent.substring(0, 50)
        });
    });

    // Handle disconnection
    socket.on('disconnect', function() {
        console.log('[ANALYTICS] WebSocket disconnected');
    });

    // Listen for new events and refresh analytics
    socket.on('new_event', function(data) {
        console.log('[ANALYTICS] New event received:', data);
        
        // Check if event is relevant to analytics (door or alarm events)
        if (data.event && (
            data.event.event_type === 'door_open' || 
            data.event.event_type === 'door_close' || 
            data.event.event_type === 'alarm_triggered'
        )) {
            console.log('[ANALYTICS] Relevant event detected, refreshing analytics...');
            
            // Show notification
            showUpdateNotification(data.event.event_type);
            
            // Reload the page to update all analytics
            // Alternative: Use AJAX to fetch updated data without full page reload
            setTimeout(function() {
                window.location.reload();
            }, 1500); // Small delay to allow event to be processed
        }
    });

    // Function to show update notification
    function showUpdateNotification(eventType) {
        // Create notification element if it doesn't exist
        let notification = document.getElementById('analytics-notification');
        if (!notification) {
            notification = document.createElement('div');
            notification.id = 'analytics-notification';
            notification.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
                color: white;
                padding: 15px 25px;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.3);
                z-index: 9999;
                display: none;
                animation: slideInRight 0.3s ease-out;
            `;
            document.body.appendChild(notification);
        }
        
        // Set notification message
        let icon = 'ðŸ“Š';
        let message = 'Analytics updating...';
        if (eventType === 'door_open') {
            icon = 'ðŸšª';
            message = 'Door opened - Updating analytics...';
        } else if (eventType === 'door_close') {
            icon = 'ðŸ”’';
            message = 'Door closed - Updating analytics...';
        } else if (eventType === 'alarm_triggered') {
            icon = 'ðŸ””';
            message = 'Alarm triggered - Updating analytics...';
        }
        
        notification.innerHTML = `
            <div style="display: flex; align-items: center; gap: 10px;">
                <span style="font-size: 24px;">${icon}</span>
                <div>
                    <strong>${message}</strong>
                    <div style="font-size: 12px; opacity: 0.9;">Refreshing in 1.5 seconds...</div>
                </div>
            </div>
        `;
        
        // Show notification
        notification.style.display = 'block';
        
        // Hide after 3 seconds
        setTimeout(function() {
            notification.style.display = 'none';
        }, 3000);
    }

    // Add CSS animation for notification
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes fadeOut {
            from {
                opacity: 1;
            }
            to {
                opacity: 0;
            }
        }
    `;
    document.head.appendChild(style);

    // Optional: Add visual indicator that real-time updates are active
    const realtimeIndicator = document.createElement('div');
    realtimeIndicator.id = 'realtime-indicator';
    realtimeIndicator.innerHTML = `
        <div style="
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(16, 185, 129, 0.9);
            color: white;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        ">
            <span style="
                width: 8px;
                height: 8px;
                background: white;
                border-radius: 50%;
                animation: pulse 2s infinite;
            "></span>
            <span>Real-time Updates Active</span>
        </div>
    `;
    document.body.appendChild(realtimeIndicator);

    // Add pulse animation for indicator
    const pulseStyle = document.createElement('style');
    pulseStyle.textContent = `
        @keyframes pulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }
    `;
    document.head.appendChild(pulseStyle);

});
</script>
{% endblock %}
